on_load-map-main:
    goto "on_load-map-main-fresh-game-check"
    
on_load-map-main-fresh-game-check:
    if flag "begunthegame" is false then goto "on_load-map-main-newgame-start"
    set hex control on
    goto "on_load-map-main-bobmoss-check"
    
on_load-map-main-newgame-start:
    set flag "begunthegame" to true
    set hex control off
    fade in camera from #000000 over 1ms
    load map "magehouse"
    
on_load-map-main-bobmoss-check:
    if flag "storyflag-bobmoss" is true then goto "on_load-map-main-bobmoss-hide"
    goto "on_load-map-main-rake-check"
    
on_load-map-main-bobmoss-hide:
    teleport entity "Bob Moss" to geometry "catwalk-hide"
    goto "on_load-map-main-rake-check"
    
on_load-map-main-rake-check:
    if flag "storyflag-rake" is true then goto "on_load-map-main-rake-do"
    goto "on_load-map-main-glitch_billy-check"
    
on_load-map-main-rake-do:
    copy "rake-in-lake"
    set entity "Goose" interactScript to "honk-to-make-rake-float"
    goto "on_load-map-main-glitch_billy-check"
    
rake-in-lake:
    teleport entity "Rake" to geometry "rake-lake-point"
    
on_load-map-main-glitch_billy-check:
    if flag "billy-unglitched" is true then goto "on_load-map-main-glitch_billy-do"
    goto "on_load-map-main-glitch_kid-check"
    
on_load-map-main-glitch_billy-do:
    make entity "Billy" unglitched
    goto "on_load-map-main-glitch_kid-check"
    
on_load-map-main-glitch_kid-check:
    if flag "kid-unglitched" is true then goto "on_load-map-main-glitch_kid-do"
    goto "on_load-map-main-glitch_fountain-check"
    
on_load-map-main-glitch_kid-do:
    make entity "Kid" unglitched
    goto "on_load-map-main-glitch_fountain-check"
    
on_load-map-main-glitch_fountain-check:
    if flag "fountain-unglitched" is true then goto "on_load-map-main-glitch_fountain-do"
    goto "on_load-map-main-glitch_hamster-check"
    
on_load-map-main-glitch_fountain-do:
    make entity "Fountain" unglitched
    goto "on_load-map-main-glitch_hamster-check"
    
on_load-map-main-glitch_hamster-check:
    if flag "main_hamster-unglitched" is true then goto "on_load-map-main-glitch_hamster-do"
    goto "on_load-map-main-sheep-check"
    
on_load-map-main-glitch_hamster-do:
    make entity "Hamster" unglitched
    goto "on_load-map-main-sheep-check"
    
on_load-map-main-sheep-check:
    if flag "storyflag-shepherd" is true then goto "on_load-map-main-sheep-do"
    goto "on_load-map-main-bender-check"
    
on_load-map-main-sheep-do:
    copy "sheep-in-pen"
    goto "on_load-map-main-bender-check"
    
sheep-in-pen:
    teleport entity "Baa" to geometry "baa_point"
    teleport entity "Ram" to geometry "ram_point"
    teleport entity "Ewe" to geometry "ewe_point"
    teleport entity "Helga" to geometry "helga_point"
    
on_load-map-main-bender-check:
    if flag "storyflag-bender" is true then goto "on_load-map-main-bender-do"
    goto "on_load-map-main-debug-check"
    
on_load-map-main-bender-do:
    copy "bender-happybutt"
    goto "on_load-map-main-debug-check"
    
bender-happybutt:
    set entity "Bender" type to "bender"
    
on_load-map-main-debug-check:
    if flag "debug-mode" is false then goto "hide-debug-map-main-do"
    goto "on_load-map-cutscene-check"
    
hide-debug-map-main-do:
    copy "hide-debug-map-main"
    goto "on_load-map-cutscene-check"
    
hide-debug-map-main:
    teleport entity "Debug Exa" to geometry "catwalk-hide"
    teleport entity "Debug Exa 0" to geometry "catwalk-hide"
    teleport entity "Debug Exa 2" to geometry "catwalk-hide"
    teleport entity "Debug Exa 3" to geometry "catwalk-hide"
    teleport entity "Debug Exa 90" to geometry "catwalk-hide"
    teleport entity "Debug Exa 91" to geometry "catwalk-hide"
    teleport entity "Debug Exa 92" to geometry "catwalk-hide"
    teleport entity "Debug Exa 95" to geometry "catwalk-hide"
    teleport entity "Credits Fish" to geometry "catwalk-hide"
    teleport entity "Chaos Fish" to geometry "catwalk-hide"
    
on_load-map-cutscene-check:
    if flag "walked-to-lodge" is false then goto "on_load-map-main-goodmorning-walk"
    if flag "hintman-explanation" is false then goto "on_load-map-main-hintman-cutscene"
    goto "on_load-map-main-warps"
    
on_load-map-main-goodmorning-walk:
    goto "walk-to-lodge"
    
on_load-map-main-hintman-cutscene:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-lodge" over 400ms
    copy "hintman-cutscene"
        /* doc: see script-elders.json for this */
    set player control on
    set flag "hintman-explanation" to true
    
on_load-map-main-warps:
    if warp state is "enter_from-east" then goto "enter_from-east"
    if warp state is "enter_from-west" then goto "enter_from-west"
    if warp state is "exit_from-bobsclub" then goto "enter_from-bobsclub"
    if warp state is "exit_from-bakery" then goto "enter_from-bakery"
    if warp state is "exit_from-lodge" then goto "enter_from-lodge"
    if warp state is "exit_from-greenhouse" then goto "enter_from-greenhouse"
    if warp state is "exit_from-magehouse" then goto "enter_from-magehouse"
    if warp state is "exit_from-oldcouplehouse" then goto "enter_from-oldcouplehouse"
    if warp state is "exit_from-family" then goto "enter_from-family"
    if warp state is "exit_from-credits" then goto "enter_from-credits"
    if warp state is "exit_from-woprhouse" then goto "enter_from-woprhouse"
    
show_dialog-yabbo:
    set entity "%PLAYER%" tickScript to "yabbo-watch"
    show dialog "dialog-yabbo"
    set entity "%PLAYER%" tickScript to "null_script"
    
yabbo-watch:
    turn entity "%PLAYER%" toward entity "Yabbo Mongo"
    
show_dialog-construction:
    show dialog "dialog-construction"
    
show_dialog-messageboard:
    show dialog "dialog-messageboard"
    
show_dialog-cleo-glitched:
    show dialog "dialog-cleo-glitched"
    set entity "%SELF%" interactScript to "show_dialog-cleo1"
    
turn-padding-start:
    set player control off
    wait 200ms
    
turn-padding-end:
    wait 0ms
    set player control on
    
cat-and-cleo-convo-turn:
    turn entity "Cleo" toward entity "Cat"
    turn entity "Cat" toward entity "Cleo"
    
cat-and-cleo-convo-turn-player:
    copy "turn-padding-start"
    turn entity "Cleo" toward entity "%PLAYER%"
    turn entity "Cat" toward entity "%PLAYER%"
    copy "turn-padding-end"
    
show_dialog-cleo1:
    if entity "%SELF%" is glitched then goto "show_dialog-cleo-glitched"
    copy "cat-and-cleo-convo-turn"
    show dialog "dialog-cleo1"
    set entity "Cleo" interactScript to "show_dialog-cleo2"
    
show_dialog-cleo2:
    if entity "%SELF%" is glitched then goto "show_dialog-cleo-glitched"
    copy "cat-and-cleo-convo-turn"
    show dialog "dialog-cleo2"
    set entity "Cleo" interactScript to "show_dialog-cleo1"
    
show_dialog-cat-glitched:
    show dialog "dialog-cat-glitched"
    set entity "%SELF%" interactScript to "show_dialog-cat"
    
show_dialog-cat:
    if variable "hint-tracking" is 61 then goto "show_dialog-cat-boss"
    if variable "hint-tracking" is 62 then goto "show_dialog-cat-boss"
    if entity "%SELF%" is glitched then goto "show_dialog-cat-glitched"
    show dialog "dialog-cat1"
    copy "turn-padding-start"
    copy "cat-and-cleo-convo-turn-player"
    show dialog "dialog-cat2"
    copy "cat-and-cleo-convo-turn"
    copy "turn-padding-end"
    
show_dialog-cat-boss:
    show dialog "dialog-cat-boss1"
    copy "turn-padding-start"
    copy "cat-and-cleo-convo-turn-player"
    show dialog "dialog-cat-boss2"
    if entity "%PLAYER%" type is "pipscat" then goto "show_dialog-cat-boss-alt"
    show dialog "dialog-cat-boss3"
    goto "show_dialog-cat-boss-wrapup"
    
show_dialog-cat-boss-alt:
    show dialog "dialog-cat-boss3-alt"
    goto "show_dialog-cat-boss-wrapup"
    
show_dialog-cat-boss-wrapup:
    copy "cat-and-cleo-convo-turn"
    copy "turn-padding-end"
    copy "set-hint-max-from-cleo"
    set flag "white-cat" to true
    set entity "%SELF%" interactScript to "show_dialog-cat"
    
cat-watch:
    if entity "Cat" is not inside geometry "cat-watch-box" then goto "cat-rescue-protocol"
    
cat-rescue-protocol:
    teleport entity "Cat" to geometry "cat-rescue-path"
    walk entity "Cat" along geometry "cat-rescue-path" over 800ms
    copy "cat-and-cleo-convo-turn"
    set entity "Cat" tickScript to "cat-watch"
    
cleo-watch:
    if entity "Cleo" is not inside geometry "cleo-watch-box" then goto "cleo-rescue-protocol"
        /* doc: WARNING!! if you change who is watching, change who to null_script for the walk-to-lodge cutscene!!! */
    
cleo-rescue-protocol:
    teleport entity "Cleo" to geometry "cleo-rescue-path"
    walk entity "Cleo" along geometry "cleo-rescue-path" over 800ms
    copy "cat-and-cleo-convo-turn"
    set entity "Cleo" tickScript to "cleo-watch"
    
on_tick-main:
    if entity "%PLAYER%" is inside geometry "door-bakery-entrance" then goto "load_map-bakery"
    if entity "%PLAYER%" is inside geometry "door-family-entrance" then goto "load_map-family"
    if entity "%PLAYER%" is inside geometry "door-greenhouse-entrance" then goto "load_map-greenhouse"
    if entity "%PLAYER%" is inside geometry "door-magehouse-entrance" then goto "load_map-magehouse"
    if entity "%PLAYER%" is inside geometry "door-lodge-entrance" then goto "load_map-lodge"
    if entity "%PLAYER%" is inside geometry "door-oldcouplehouse-entrance" then goto "load_map-oldcouplehouse"
    if entity "%PLAYER%" is inside geometry "door-woprhouse-entrance" then goto "load_map-woprhouse"
    if entity "%PLAYER%" is inside geometry "door_to-town-east" then goto "wrap_from-west"
    if entity "%PLAYER%" is inside geometry "door_to-town-west" then goto "wrap_from-east"
    
load_map-bakery:
    load map "bakery"
    
load_map-oldcouplehouse:
    load map "oldcouplehouse"
    
load_map-greenhouse:
    load map "greenhouse"
    
load_map-magehouse:
    load map "magehouse"
    
load_map-lodge:
    load map "lodge"
    
load_map-family:
    load map "family"
    
load_map-woprhouse:
    load map "woprhouse"
    
wrap_from-west:
    set entity "%PLAYER%" tickScript to "on_tick-wrap_into-west"
    fade out camera to #000000 over 600ms
    set entity "%PLAYER%" tickScript to "on_tick-wrap_from-west"
    fade in camera from #000000 over 600ms
    goto "on_tick-main"
    
on_tick-wrap_into-west:
    set player control off
    walk entity "%PLAYER%" to geometry "exit_to-west" over 3500ms
    goto "null_script"
    
on_tick-wrap_from-west:
    walk entity "%PLAYER%" along geometry "enter_from-east" over 600ms
    set player control on
    goto "null_script"
    
wrap_from-east:
    set entity "%PLAYER%" tickScript to "on_tick-wrap_into-east"
    fade out camera to #000000 over 600ms
    set entity "%PLAYER%" tickScript to "on_tick-wrap_from-east"
    fade in camera from #000000 over 600ms
    goto "on_tick-main"
    
on_tick-wrap_into-east:
    set player control off
    walk entity "%PLAYER%" to geometry "exit_to-east" over 3500ms
    goto "null_script"
    
on_tick-wrap_from-east:
    walk entity "%PLAYER%" along geometry "enter_from-west" over 600ms
    set player control on
    goto "null_script"
    
enter_from-bobsclub:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-bobsclub" over 200ms
    set player control on
    
enter_from-oldcouplehouse:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-oldcouplehouse" over 200ms
    set player control on
    
enter_from-greenhouse:
    set player control off
    teleport entity "%PLAYER%" to geometry "enter_from-greenhouse"
    walk entity "%PLAYER%" along geometry "enter_from-greenhouse" over 200ms
    set player control on
    
enter_from-magehouse:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-magehouse" over 200ms
    set player control on
    
enter_from-lodge:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-lodge" over 200ms
    set player control on
    
enter_from-family:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-family" over 200ms
    set player control on
    
enter_from-bakery:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-bakery" over 200ms
    set player control on
    
enter_from-woprhouse:
    set player control off
    walk entity "%PLAYER%" along geometry "enter_from-woprhouse" over 200ms
    set player control on
    
show_dialog-hamster-start:
    copy "face-player"
    if entity "%SELF%" is glitched then goto "show_dialog-hamster-glitched"
    if flag "hamster-endstory" is true then goto "show_dialog-hamster-start-s"
    show dialog "dialog-hamster-start"
    set flag "hamster-endstory" to true
    
show_dialog-hamster-start-s:
    show dialog "dialog-hamster-start-s"
    play entity "%SELF%" animation 2 x2
    set entity "%SELF%" interactScript to "show_dialog-hamster-start"
    
show_dialog-hamster-glitched:
    show dialog "dialog-hamster-glitched"
    goto "hamster-glitchhint-eval"
    
hamster-glitchhint-eval:
    if flag "main_hamster-unglitched" is false then goto "hamster-hint-yes"
    set entity "%SELF%" interactScript to "show_dialog-hamster-start"
    
hamster-hint-yes:
    copy "set-hint-glitch"
    set entity "%SELF%" interactScript to "show_dialog-hamster-start"
    
show_dialog-marta-glitched:
    show dialog "dialog-marta-glitched"
    set entity "%SELF%" interactScript to "show_dialog-marta-start"
    
show_dialog-marta-start-s:
    show dialog "dialog-marta-start-s"
    set entity "%SELF%" interactScript to "show_dialog-marta-start"
    
show_dialog-marta-start:
    turn entity "Marta" toward entity "%PLAYER%"
    if entity "%SELF%" is glitched then goto "show_dialog-marta-glitched"
    if entity "Marta" type is not "marta_broom" then goto "show_dialog-marta-cheat"
    if flag "marta-backstory" is true then goto "show_dialog-marta-start-s"
    show dialog "dialog-marta-start"
    set flag "marta-backstory" to true
    
show_dialog-marta-cheat:
    show dialog "dialog-marta-cheat"
    set entity "Marta" interactScript to "show_dialog-marta-start"
    
show_dialog-safety-skyler:
    show dialog "dialog-safety-skyler"
    
fountain-interact:
    if entity "%SELF%" is not glitched then goto "fountain-interact-fixed"
    show dialog "dialog-fountain-interact"
    
fountain-interact-fixed:
    show dialog "dialog-fountain-interact-fixed"
    set entity "%SELF%" interactScript to "fountain-interact"
    
fountain-glitchwatch:
    if entity "%SELF%" is not glitched then goto "fountain_now_unglitched"
    
fountain_now_unglitched:
    set flag "fountain-unglitched" to true
    goto "null_script"
    
hamster-glitchwatch:
    if entity "%SELF%" is not glitched then goto "hamster_now_unglitched"
    
hamster_now_unglitched:
    set flag "main_hamster-unglitched" to true
    goto "null_script"
    
enter_from-credits:
    teleport entity "%PLAYER%" to geometry "from-credits-spot"
    set player control off
    fade in camera from #000000 over 800ms
    set player control on
    copy "enter_from-credits-demobonus-eval"
    if flag "demobonus-jackob-informed" is true then goto "enter_from-credits-end"
    set flag "demobonus" to true
        /* doc: set now because all story flags and credits confirmed true; use this flag for same check hereafter */
    show dialog "dialog-jackob-demobonus"
    set flag "demobonus-jackob-informed" to true
    goto "enter_from-credits-end"
    
enter_from-credits-end:
    goto "null_script"
    
enter_from-credits-demobonus-eval:
    if flag "wonthedemo" is false then goto "enter_from-credits-end"
    if flag "storyflag-catwork" is false then goto "enter_from-credits-end"
    if flag "storyflag-shepherd" is false then goto "enter_from-credits-end"
    if flag "storyflag-bender" is false then goto "enter_from-credits-end"
    if flag "storyflag-baker" is false then goto "enter_from-credits-end"
    if flag "storyflag-bobmoss" is false then goto "enter_from-credits-end"
    if flag "storyflag-bea1" is false then goto "enter_from-credits-end"
    if flag "storyflag-trekkie" is false then goto "enter_from-credits-end"
    if flag "storyflag-sportskid" is false then goto "enter_from-credits-end"
    if flag "storyflag-bea2" is false then goto "enter_from-credits-end"
    if flag "storyflag-rake" is false then goto "enter_from-credits-end"
    if flag "storyflag-verthandi" is false then goto "enter_from-credits-end"
    
yabbo-journey:
    walk entity "%SELF%" along geometry "%ENTITY_PATH%" over 22000ms
    